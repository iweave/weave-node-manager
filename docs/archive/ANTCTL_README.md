# Antctl

Antctl is a command-line application for installing, managing, and operating `antnode` as a service.

It runs on Linux, macOS and Windows.

## Installation

The latest version can be installed via [antup](https://github.com/maidsafe/antup):
```
antup antctl
```

A binary can also be obtained for your platform from the releases in this repository.

## Nodes as Services

The primary use case for Antctl is to setup `antnode` as a long-running background service, using
the service infrastructure provided by the operating system.

On macOS and most distributions of Linux, user-mode services are supported. Traditionally, services
are system-wide infrastructure that require elevated privileges to create and work with. However,
with user-mode services, they can be defined and used without sudo. The main difference is, a
user-mode service requires an active user session, whereas a system-wide service can run completely
in the background, without any active session. It's a user decision as to which is more appropriate
for their use case. On Linux, some service managers, like OpenRC, used on Alpine, do not support
user-mode services. Most distributions use Systemd, which does have support for them.

The commands defined in the rest of this guide will operate on the basis of a user-mode service, and
so will not use `sudo`. If you would like to run system-wide services, you can go through the same
guide, but just prefix each command with `sudo`.

Windows does not support user-mode services at all, and therefore, Antctl must always be
used in an elevated, administrative session.

### Create Services

First, use the `add` command to create some services:
```
$ antctl add --count 3
```

This downloads the latest version of the `antnode` binary and creates three services.

There are many arguments available for customising the service. For example, you can choose the port the node will run on, or the version of `antnode`. Run `antctl add --help` to see all available options.

_Note_: elevated privileges are required for creating services, on all platforms.

Now run the `status` command:
```
$ antctl status
=================================================
                Antnode Services
=================================================
Refreshing the node registry...
Service Name       Peer ID                                              Status  Connected Peers
antnode1          -                                                    ADDED               -
antnode2          -                                                    ADDED               -
antnode3          -                                                    ADDED               -
```

We can see the services have been added, but they are not running yet.

### Start Services

Use the `start` command to start each service:
```
$ antctl start
```

Providing no arguments will start all available services. If need be, it's possible to start services individually, using the `--service-name` argument.

With the services started, run the `status` command again:
```
$ antctl status
=================================================
                Antnode Services
=================================================
Refreshing the node registry...
Service Name       Peer ID                                              Status  Connected Peers
antnode1          12D3KooWGQu92xCXuiK6AysbHn6kHyfXqyzNDxNGnnDTgd56eveq RUNNING              81
antnode2          12D3KooWQGVfcwrPFvC6PyCva1cJu8NZVhdZCuPHJ4vY79yuKC3A RUNNING              82
antnode3          12D3KooWMqRH6EF1Km61TAW9wTuv9LgDabKMY9DJSGyrxUafXP6b RUNNING              79
```

We can see our services are running and the nodes have connections to other peers.

Now, run the `status` command again, but with the `--details` flag:
```
=================================================
                Antnode Services
=================================================
Refreshing the node registry...
============================
antnode1 - RUNNING
============================
Version: 0.105.0
Peer ID: 12D3KooWGQu92xCXuiK6AysbHn6kHyfXqyzNDxNGnnDTgd56eveq
RPC Socket: 127.0.0.1:41785
Listen Addresses: Some["/ip4/127.0.0.1/udp/34653/quic-v1/p2p/12D3KooWGQu92xCXuiK6AysbHn6kHyfXqyzNDxNGnnDTgd56eveq", "/ip4/192.168.121.7/udp/34653/quic-v1/p2p/12D3KooWGQu92xCXuiK6AysbHn6kHyfXqyzNDxNGnnDTgd56eveq"]
PID: 3137
Data path: /var/antctl/services/antnode1
Log path: /var/log/antnode/antnode1
Bin path: /var/antctl/services/antnode1/antnode
Connected peers: 10
<remaining output snipped>
```

We get some more details for each node, including the path to its logs. Using the location provided, feel free to take a look at the logs being generated by the node.

The nodes could now be left running like this, but for the purposes of this guide, we will do some more things.

### Add More Nodes

It's possible to run the `add` command again, as before:
```
antctl add --count 3
```

The subsequent `status` command will show us an additional three nodes, for a total of six:
```
$ antctl status
=================================================
                Antnode Services
=================================================
Refreshing the node registry...
Service Name       Peer ID                                              Status  Connected Peers
antnode1          12D3KooWGQu92xCXuiK6AysbHn6kHyfXqyzNDxNGnnDTgd56eveq RUNNING               4
antnode2          12D3KooWQGVfcwrPFvC6PyCva1cJu8NZVhdZCuPHJ4vY79yuKC3A RUNNING               4
antnode3          12D3KooWMqRH6EF1Km61TAW9wTuv9LgDabKMY9DJSGyrxUafXP6b RUNNING               3
antnode4          -                                                    ADDED               -
antnode5          -                                                    ADDED               -
antnode6          -                                                    ADDED               -
```

Again, the new nodes have not been started.

Run the `start` command to start them, then observe the status:
```
$ antctl status
=================================================
                Antctl Services
=================================================
Refreshing the node registry...
Service Name       Peer ID                                              Status  Connected Peers
antnode1          12D3KooWGQu92xCXuiK6AysbHn6kHyfXqyzNDxNGnnDTgd56eveq RUNNING             138
antnode2          12D3KooWQGVfcwrPFvC6PyCva1cJu8NZVhdZCuPHJ4vY79yuKC3A RUNNING             177
antnode3          12D3KooWMqRH6EF1Km61TAW9wTuv9LgDabKMY9DJSGyrxUafXP6b RUNNING             144
antnode4          12D3KooWLH9VRAoUMj4bUjtzcKS3mqfzyc46TxBkBzvUXfV1bjaT RUNNING               2
antnode5          12D3KooWEcbpvSSTmSyuzqP3gE9bE7uqYFatHhkJXr8PBiqmESEG RUNNING               1
antnode6          12D3KooWBip2g5FakT1dZHdrhdmnctgKqhbRBQA5ZpvtHh4XPRXJ RUNNING              30
```

### Removing Nodes

If for some reason we want to remove one of our nodes, we can do so using the `remove` command.

Suppose we wanted to remove the 5th service. First of all, we need to stop the service. Run the following command:
```
$ antctl stop --service-name antnode5
```

Observe that `antnode5` has been stopped, but the others are still running:
```
$ antctl status
=================================================
                Antnode Services
=================================================
Refreshing the node registry...
Service Name       Peer ID                                              Status  Connected Peers
antnode1          12D3KooWGQu92xCXuiK6AysbHn6kHyfXqyzNDxNGnnDTgd56eveq RUNNING              10
antnode2          12D3KooWQGVfcwrPFvC6PyCva1cJu8NZVhdZCuPHJ4vY79yuKC3A RUNNING               5
antnode3          12D3KooWMqRH6EF1Km61TAW9wTuv9LgDabKMY9DJSGyrxUafXP6b RUNNING               2
antnode4          12D3KooWLH9VRAoUMj4bUjtzcKS3mqfzyc46TxBkBzvUXfV1bjaT RUNNING               2
antnode5          12D3KooWEcbpvSSTmSyuzqP3gE9bE7uqYFatHhkJXr8PBiqmESEG STOPPED               -
antnode6          12D3KooWBip2g5FakT1dZHdrhdmnctgKqhbRBQA5ZpvtHh4XPRXJ RUNNING              29
```

Now that it's been stopped, remove it:
```
$ antctl remove --service-name antnode5
```

The `status` command will no longer show the service:
```
vagrant@ubuntu2204:~$ antctl status
=================================================
                Antnode Services
=================================================
Refreshing the node registry...
Service Name       Peer ID                                              Status  Connected Peers
antnode1          12D3KooWGQu92xCXuiK6AysbHn6kHyfXqyzNDxNGnnDTgd56eveq RUNNING               2
antnode2          12D3KooWQGVfcwrPFvC6PyCva1cJu8NZVhdZCuPHJ4vY79yuKC3A RUNNING              96
antnode3          12D3KooWMqRH6EF1Km61TAW9wTuv9LgDabKMY9DJSGyrxUafXP6b RUNNING             127
antnode4          12D3KooWLH9VRAoUMj4bUjtzcKS3mqfzyc46TxBkBzvUXfV1bjaT RUNNING              76
antnode6          12D3KooWBip2g5FakT1dZHdrhdmnctgKqhbRBQA5ZpvtHh4XPRXJ RUNNING             133
```

However, we will still see it in the detailed view:
```
$ antctl status --details
=================================================
                Antnode Services
=================================================
Refreshing the node registry...
<output snipped>
============================
antnode5 - REMOVED
============================
Version: 0.105.0
Peer ID: 12D3KooWEcbpvSSTmSyuzqP3gE9bE7uqYFatHhkJXr8PBiqmESEG
RPC Socket: 127.0.0.1:38579
Listen Addresses: Some(["/ip4/127.0.0.1/udp/58354/quic-v1/p2p/12D3KooWEcbpvSSTmSyuzqP3gE9bE7uqYFatHhkJXr8PBiqmESEG", "/ip4/192.168.121.7/udp/58354/quic-v1/p2p/12D3KooWEcbpvSSTmSyuzqP3gE9bE7uqYFatHhkJXr8PBiqmESEG"])
PID: -
Data path: /var/antctl/services/antnode5
Log path: /var/log/antnode/antnode5
Bin path: /var/antctl/services/antnode5/antnode
Connected peers: -
<output snipped>
```

## Upgrades

Antctl can be used to continually upgrade node services.

Suppose we have five services:
```
$ antctl status
=================================================
                Antnode Services
=================================================
Refreshing the node registry...
Service Name       Peer ID                                              Status  Connected Peers
antnode1          12D3KooWKaNFPoRf8E2vsdSwBNyhWpe7csNkqwXaunNVxXGarxap RUNNING               1
antnode2          12D3KooWNbRBR43rdFR44EAbwzBrED3jWUiWKkHD2oabw2jKZ9eF RUNNING               1
antnode3          12D3KooWGYEuqXRhKVF2WK499oCBpkh9c6K7jy8BNSfqGosSzNZ8 RUNNING               1
antnode4          12D3KooWS6WGnhbSfLywaepfZbbqgxTLhr66N1PXU4GVLWDBRZRF RUNNING               1
antnode5          12D3KooWNdEYQAutzcGo26rZayew2rzE24y5VFVxTnsefNevc1Ly RUNNING               1
```

Using the `--details` flag, we can see they are not at the latest version:
```
$ antctl status --details
=================================================
                Antnode Services
=================================================
Refreshing the node registry...
============================
antnode1 - RUNNING
============================
Version: 0.104.38
Peer ID: 12D3KooWKaNFPoRf8E2vsdSwBNyhWpe7csNkqwXaunNVxXGarxap
RPC Socket: 127.0.0.1:37931
Listen Addresses: Some(["/ip4/127.0.0.1/udp/39890/quic-v1/p2p/12D3KooWKaNFPoRf8E2vsdSwBNyhWpe7csNkqwXaunNVxXGarxap", "/ip4/192.168.121.114/udp/39890/quic-v1/p2p/12D3KooWKaNFPoRf8E2vsdSwBNyhWpe7csNkqwXaunNVxXGarxap"])
PID: 3285
Data path: /var/antctl/services/antnode1
Log path: /var/log/antnode/antnode1
Bin path: /var/antctl/services/antnode1/antnode
Connected peers: 0
<remaining output snipped>
```

For brevity, the remaining output is snipped, but the four others are also at `0.104.38`. At the time of writing, the latest version is `0.105.3`.

We can use the `upgrade` command to get each service on the latest version:
```
$ antctl upgrade
=================================================
           Upgrade Antnode Services
=================================================
Retrieving latest version of antnode...
Latest version is 0.105.3
Downloading antnode version 0.105.3...
Download completed: /tmp/ae310e50-d104-45bc-9619-22e1328d8c8b/antnode
Refreshing the node registry...
<output snipped>
Upgrade summary:
✓ antnode1 upgraded from 0.104.38 to 0.105.3
✓ antnode2 upgraded from 0.104.38 to 0.105.3
✓ antnode3 upgraded from 0.104.38 to 0.105.3
✓ antnode4 upgraded from 0.104.38 to 0.105.3
✓ antnode5 upgraded from 0.104.38 to 0.105.3
```

Again, for brevity some output from the command was snipped, but the summary indicates that each service was upgraded from `0.104.38` to `0.105.3`.

As with other commands, if no arguments are supplied, `upgrade` operates over all services, but it's possible to use the `--service-name` or `--peer-id` arguments to upgrade specific services. Both those arguments can be used multiple times to operate over several services.

Antctl will determine the latest version of `antnode`, download it, then for each running service, if the service is older than the latest, it will stop it, copy the new binary over the old one, and start the service again.

### Downgrading

In some situations, it may be necessary to downgrade `antnode` to a previous version. The `upgrade` command supports this by providing `--version` and `--force` arguments. Each of those can be used to force Antctl to accept a lower version.


## getting node details
There is an additional report, the only antctl command that reports the metrics port

### command-output
dawn@wnm:~/weave-node-manager$ antctl status --json
{
  "nodes": [
    {
      "alpha": false,
      "schema_version": 2,
      "antnode_path": "/home/dawn/.local/share/autonomi/node/antnode1/antnode",
      "auto_restart": false,
      "connected_peers": null,
      "data_dir_path": "/home/dawn/.local/share/autonomi/node/antnode1",
      "evm_network": "ArbitrumOne",
      "initial_peers_config": {
        "first": false,
        "addrs": [],
        "network_contacts_url": [],
        "local": false,
        "ignore_cache": false,
        "bootstrap_cache_dir": null
      },
      "listen_addr": null,
      "log_dir_path": "/home/dawn/.local/share/autonomi/node/antnode1/logs",
      "log_format": null,
      "max_archived_log_files": null,
      "max_log_files": null,
      "metrics_port": 13555,
      "network_id": null,
      "node_ip": null,
      "node_port": 55555,
      "no_upnp": true,
      "number": 1,
      "peer_id": null,
      "pid": null,
      "relay": false,
      "rewards_address": "0x00455d78f850b0358e8cea5be24d415e01e107cf",
      "reward_balance": null,
      "rpc_socket_addr": "127.0.0.1:42241",
      "service_name": "antnode1",
      "status": "Added",
      "user": null,
      "user_mode": true,
      "version": "0.4.6",
      "write_older_cache_files": false
    }
  ],
  "daemon": null
}
### /command-output

---

## Using Antctl with Weave Node Manager (WNM)

WNM can use `antctl` as a process manager backend, allowing WNM's decision engine and resource monitoring to work with antctl-managed nodes.

### Prerequisites

1. Install antctl via [antup](https://github.com/maidsafe/antup):
   ```bash
   antup antctl
   ```

2. Verify antctl is in your PATH:
   ```bash
   which antctl  # Should show ~/.local/bin/antctl
   antctl --version
   ```

### Using WNM with Antctl

#### Specify Process Manager

Use the `--process_manager` flag to specify antctl as your process manager:

```bash
# User-mode antctl (no sudo required)
wnm --process_manager antctl+user --init --rewards_address 0xYourEthereumAddress

# System-mode antctl (with sudo)
sudo wnm --process_manager antctl+sudo --init --rewards_address 0xYourEthereumAddress
```

#### Import Existing Antctl Nodes

If you already have nodes managed by antctl, WNM can discover and import them:

```bash
# Survey existing antctl nodes
wnm --process_manager antctl+user --init --rewards_address faucet

# WNM will detect existing nodes via 'antctl status --json'
```

**Important**: Only import antctl clusters that were created with `--metrics-port` enabled, as WNM relies on the metrics port for node monitoring.

#### Configuration

When using antctl as the process manager:

- **Node ID**: WNM assigns sequential database IDs (1, 2, 3...)
- **Service Name**: antctl assigns service names (antnode1, antnode2, antnode3...)
- **Stored in database**: `node.service` field contains the antctl service name
- **Log Directory**: Captured from antctl's `log_dir_path` and stored in `node.log_dir`

### WNM Operations with Antctl

WNM delegates node lifecycle operations to antctl:

| WNM Operation | Antctl Command | Description |
|--------------|----------------|-------------|
| Add node | `antctl add --count 1 [options]` | Creates and starts a new node |
| Start node | `antctl start --service-name {service}` | Starts a stopped node |
| Stop node | `antctl stop --service-name {service}` | Stops a running node |
| Remove node | `antctl stop && antctl remove` | Stops and removes a node |
| Upgrade node | Stop → Copy binary → Start | WNM handles upgrade flow |
| Survey nodes | `antctl status --json` | Discovers existing nodes |
| Teardown cluster | `antctl reset --force` | Removes all nodes |

### Path Configuration

WNM overrides antctl's default paths to match WNM's platform-specific conventions:

**Flags passed to `antctl add`**:
- `--data-dir-path`: Node data directory (wnm manages)
- `--log-dir-path`: Log directory (wnm manages)
- `--port`: Node port (wnm assigns)
- `--metrics-port`: Metrics port (wnm assigns)
- `--rewards-address`: Ethereum wallet address
- `--no-upnp`: Disable UPnP (wnm controls)

**When importing existing antctl nodes**, WNM preserves the original paths from antctl's JSON output.

### Multi-Container Support

In multi-container deployments (e.g., Docker), each container can have its own antctl instance with identical service names:

- Container 1: antnode1, antnode2, antnode3
- Container 2: antnode1, antnode2, antnode3

WNM distinguishes these using the `node.container_id` foreign key in the database.

### Example: Complete Workflow

```bash
# 1. Install antctl
antup antctl

# 2. Initialize WNM with antctl as process manager
wnm --process_manager antctl+user --init \
  --rewards_address 0x00455d78f850b0358E8cea5be24d415E01E107CF \
  --node_cap 10

# 3. WNM will automatically:
#    - Discover existing antctl nodes (if any)
#    - Add new nodes based on resource availability
#    - Monitor nodes via metrics port
#    - Remove nodes when resources are constrained

# 4. Run WNM continuously (typically via cron)
wnm
```

### Monitoring and Status

WNM determines node status through the metrics port, not via `antctl status`. This allows WNM to:

- Monitor node health in real-time
- Detect node failures quickly
- Track connected peers, uptime, and records
- Make resource-based decisions

You can still use `antctl status` directly to view your nodes:

```bash
# View all nodes
antctl status

# View detailed information
antctl status --details

# View JSON output (same format WNM uses)
antctl status --json
```

### Firewall Management

WNM defaults to "null" firewall management when using antctl, as antctl is expected to manage its own port requirements. On Linux with UFW, you may need to manually configure firewall rules or use a different firewall manager.

### Troubleshooting

**Antctl not found**:
```bash
# Ensure ~/.local/bin is in your PATH
export PATH="$HOME/.local/bin:$PATH"

# Or install antctl
antup antctl
```

**Permission errors**:
```bash
# For user-mode services (recommended)
wnm --process_manager antctl+user

# For system-mode services
sudo wnm --process_manager antctl+sudo
```

**Database schema update** (for existing WNM users):

If you're upgrading from a previous version of WNM, the `log_dir` field was added to the Node schema. For SQLite databases:

```bash
# Option 1: Recreate database (loses existing data)
rm ~/.local/share/wnm/colony.db
wnm --init

# Option 2: Manual migration (preserves data)
sqlite3 ~/.local/share/wnm/colony.db
> ALTER TABLE node ADD COLUMN log_dir TEXT;
> .quit
```

### Advantages of Using Antctl with WNM

1. **Robust Service Management**: Leverages OS-native service infrastructure (systemd/launchd)
2. **Clean Integration**: WNM's decision engine + antctl's process management
3. **Flexible Deployment**: User-mode or system-mode services
4. **Easy Import**: Discover and adopt existing antctl nodes
5. **Platform Support**: Works on Linux and macOS

### Limitations

- **No auto-detection**: WNM does not automatically detect antctl availability; you must explicitly specify `--process_manager antctl+user` or `antctl+sudo`
- **Service name gaps**: When nodes are removed, antctl doesn't reuse service numbers (e.g., after removing antnode2, the next node will be antnode4, not antnode2)
- **Database migration**: Existing WNM databases need the `log_dir` field added manually

### See Also

- [WNM Process Managers](PLATFORM-SUPPORT.md)
- [Antctl GitHub Repository](https://github.com/maidsafe/antctl)
- [Antup Installation Tool](https://github.com/maidsafe/antup)